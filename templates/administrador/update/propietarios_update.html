{% extends "layouts/admin-layout.html" %}

{% load static %}
{% load i18n %}
{% load widget_tweaks %}

{% block title_page %}
  Esparta Suites - Administración
{% endblock title_page %}

{% block modulo_label %}
<span class="" id="gestionar-propietarios">Administrar Propietarios</span>
{% endblock modulo_label %}

{% block opc_panel_class %}
  class="d-none"
{% endblock opc_panel_class %}

{% block body_block %}

<script src="{% static '/js/charge-apto.js' %}"></script>

<!-- INICIO MAESTRO DE PROPIETARIOS -->
<div class="col-lg-12 mb-5 mb-lg-0 end-padding-right" id="Propietarios">
  <div class="container rounded modulo border-secondary pb-2">
    <div class="container pt-3 pb-1">

      <div class="divider"></div>
      <div class="form-group row">
        <button class="btn-option mx-auto move-up list_buttom2" id="ShowEditarPropietario" onclick="TogglePropietarioUpdate('ShowEditar')" data-toggle="popover" data-content="Editar información del propietario">
          <i class="fa fa-pencil-square-o pr-2"></i> Editar Propietario
        </button>
        <button class="btn-option mx-auto move-up list_buttom2" id="ShowAgregarInmueble" onclick="TogglePropietarioUpdate('ShowInmueble')" data-toggle="popover" data-content="Agregar inmueble al propietario">
          <i class="fa fa-list pr-2"></i> Agregar Inmueble
        </button>
      </div>
      
      <!-- FORMULARIO PARA AGREGAR UN NUEVO PROPIETARIO -->
      <div class="form-style-10 col-sm-12" id="FormEditarPropietario">
        <form method="POST">
          {% csrf_token %}
          <input type="hidden" name="form_origen" value="editar_propietario">
          <div class="section mb-3"><span>1</span>Información del propietario</div>
          <div class="inner-wrap form-row">
            <div class="form-group col-sm-12">
              <label for="{{ propietarios_form.nombre_propietario.name }}" class="col-sm-12 text-dark">{{ propietarios_form.nombre_propietario.label }}:</label>
              <div class="col-sm-12">
                {% render_field propietarios_form.nombre_propietario class="form-control text-dark" placeholder="Ingrese el nombre completo del propietario" value=propietarios.nombre_propietario %}
                {% for error in propietarios_form.nombre_propietario.errors %}
                <div class="alert alert-danger mt-2">{{ error }}</div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="inner-wrap form-row">
            <div class="form-group col-sm-4">
              <label for="{{ select_country.pais_residencia.name }}" class="col-sm-12 text-dark">{{ select_country.pais_residencia.label }}:</label>
              <div class="col-sm-12">
                <select name="{{ select_country.pais_residencia.name }}" id="{{ select_country.tipo_dni_titular.name }}"
                        class="form-control text-dark">
                  {% for select in select_country.pais_residencia %}
                  {{select}}
                  {% for error in select_country.pais_residencia.errors %}
                  <div class="alert alert-danger mt-2">{{ error }}</div>
                  {% endfor %}
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="form-group col-sm-2">
              <label for="{{ select_genero.genero.name }}" class="col-sm-3 text-dark">{{ select_genero.genero.label }}:</label>
              <div class="col-sm-12">
                <select name="{{ select_genero.genero.name }}" id="{{ select_genero.genero.name }}"
                        class="form-control text-dark">
                  {% for select in select_genero.genero %}
                  {{select}}
                  {% for error in select_genero.genero.errors %}
                  <div class="alert alert-danger mt-2">{{ error }}</div>
                  {% endfor %}
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="form-group col-sm-2">
              <label for="{{ select_tipo_doc.tipo_dni.name }}" class="col-sm-12 text-dark">{{ select_tipo_doc.tipo_dni.label }}:</label>
              <div class="col-sm-12">
                <select name="{{ select_tipo_doc.tipo_dni.name }}" id="{{ select_tipo_doc.tipo_dni_titular.name }}"
                        class="form-control text-dark">
                  {% for select in select_tipo_doc.tipo_dni %}
                  {{select}}
                  {% for error in select_tipo_doc.tipo_dni.errors %}
                  <div class="alert alert-danger mt-2">{{ error }}</div>
                  {% endfor %}
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="form-group col-sm-4">
              <label for="{{ propietarios_form.dni.name }}" class="col-sm-12 text-dark">{{ propietarios_form.dni.label }}:</label>
              <div class="col-sm-12">
                {% render_field propietarios_form.dni class="form-control text-dark" name=propietarios_form.dni.name placeholder="Ingrese el número de su documento" value=propietarios.dni %}
                {% for error in propietarios_form.dni.errors %}
                <div class="alert alert-danger mt-2">{{ error }}</div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="inner-wrap form-row">

            <div class="form-group col-sm-3">
              <label for="{{ select_cod_hab.codigo_tlf_hab.name }}" class="col-sm-12 text-dark">{{ select_cod_hab.codigo_tlf_hab.label }}:</label>
              <div class="col-sm-12">
                <select name="{{ select_cod_hab.codigo_tlf_hab.name }}" id="{{ select_cod_hab.tipo_dni_titular.name }}"
                        class="form-control text-dark">
                  {% for select in select_cod_hab.codigo_tlf_hab %}
                  {{select}}
                  {% for error in select_cod_hab.codigo_tlf_hab.errors %}
                  <div class="alert alert-danger mt-2">{{ error }}</div>
                  {% endfor %}
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="form-group col-sm-3">
              <label for="{{ propietarios_form.telefono_hab.name }}" class="col-sm-12 text-dark">{{ propietarios_form.telefono_hab.label }}:</label>
              <div class="col-sm-12">
                {% render_field propietarios_form.telefono_hab class="form-control text-dark" name=propietarios_form.telefono_hab.name placeholder="Número de teléfono de habitación" value=propietarios.telefono_hab %}
                {% for error in propietarios_form.telefono_hab.errors %}
                <div class="alert alert-danger mt-2">{{ error }}</div>
                {% endfor %}
              </div>
            </div>

            <div class="form-group col-sm-3">
              <label for="{{ select_cod_mov.codigo_tlf_movil.name }}" class="col-sm-12 text-dark">{{ select_cod_mov.codigo_tlf_movil.label }}:</label>
              <div class="col-sm-12">
                <select name="{{ select_cod_mov.codigo_tlf_movil.name }}"
                        id="{{ select_cod_mov.codigo_tlf_movil.name }}" class="form-control text-dark">
                  {% for select in select_cod_mov.codigo_tlf_movil %}
                  {{select}}
                  {% for error in select_cod_mov.codigo_tlf_movil.errors %}
                  <div class="alert alert-danger mt-2">{{ error }}</div>
                  {% endfor %}
                  {% endfor %}
                </select>
              </div>
            </div>

            <div class="form-group col-sm-3">
              <label for="{{ propietarios_form.telefono_movil.name }}" class="col-sm-12 text-dark">{{ propietarios_form.telefono_movil.label }}:</label>
              <div class="col-sm-12">
                {% render_field propietarios_form.telefono_movil class="form-control text-dark" name=propietarios_form.telefono_movil.name placeholder="Número de teléfono móvil" value=propietarios.telefono_movil %}
                {% for error in propietarios_form.telefono_movil.errors %}
                <div class="alert alert-danger mt-2">{{ error }}</div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="section"><span>2</span>Información de cuenta</div>
          <div class="inner-wrap form-row">
            <div class="form-group col-sm-12">
              <label for="{{ user_form.email.name }}" class="col-sm-12 text-dark">{{ user_form.email.label }}:</label>
              <div class="col-sm-12">
                {% render_field user_form.email class="form-control text-dark" name=user_form.email.name id=user_form.email.name placeholder="Ingrese el correo electrónico del propietario" value=propietarios.id_usuario.email %}
                {% for error in user_form.email.errors %}
                <div class="alert alert-danger mt-2">{{ error }}</div>
                {% endfor %}
              </div>
            </div>
          </div>

          <input type="text" name="id_prop" id="id_prop" value={{propietarios.id_propietario}} hidden>

          <div class="button-section mx-auto">
            <button type="submit" class="btn btn-success col-sm-4 mt-3 move-up" data-toggle="popover"
                    data-content="Haz click aquí para agregar el nuevo gasto a la lista"><i
                    class="fa fa-check pr-1"></i> Aceptar
            </button>
            <a type="reset" href="/home/administrar/propietarios/" class="btn btn-danger col-sm-2 mt-3 ml-3 move-up"><i class="fa fa-times pr-1"></i>
              Cancelar
            </a>
          </div>
        </form>
      </div>

      <div class="form-style-10 col-sm-12 d-none" id="FormAgregarInmueble">
        <form method="POST">
          {% csrf_token %}
          <input type="hidden" name="form_origen" value="agregar_inmueble">
          <div class="section mb-3"><span>2</span>Agregar inmueble al propietario</div>
          <div class="inner-wrap form-row">
            <div class="form-group col-sm-6">
              <label for="select_torre_prop" class="col-sm-12 text-dark">Torre:</label>
              <div class="col-sm-12">
                <select name="torre_prop" class="form-control text-dark" id="select_torre_prop">
                  {% if torres %}
                  <option value="">Seleccione una torre...</option>
                  {% for t in torres %}
                  <option value="{{ t.id_torre }}">{{ t.nombre_torre }}</option>
                  {% endfor %}
                  {% else %}
                  <option value="">No hay torres disponibles</option>
                  {% endif %}
                </select>
              </div>
            </div>
          </div>
          <div class="inner-wrap form-row">
            <div class="form-group col-sm-12">
              <label class="col-sm-12 text-dark">Seleccione los inmuebles:</label>
              <div class="col-sm-12">
                {% if domicilios_disponibles %}
                  <select class="form-control text-dark" id="select_domicilio_prop" disabled>
                    <option value="">Seleccione una torre primero...</option>
                    {% for dom in domicilios_disponibles %}
                      <option value="{{ dom.id_domicilio }}" data-torre="{{ dom.id_torre_id }}">{{ dom.nombre_domicilio }}</option>
                    {% endfor %}
                  </select>
                {% else %}
                  <p class="text-danger">No hay inmuebles disponibles.</p>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="inner-wrap form-row d-none" id="domicilios_seleccionados_wrap">
            <div class="form-group col-sm-12">
              <label class="col-sm-12 text-dark">Inmuebles:</label>
              <div class="col-sm-12">
                <table id="tabla_domicilios_seleccionados" width="100%" style="font-size: 14px;"
                       class="table table-sm table-hover table-responsive-xl table-responsive-lg table-responsive-md mt-2">
                  <thead class="table-header">
                    <tr>
                      <th style="font-weight: 400;">Inmueble</th>
                      <th style="font-weight: 400;">Acción</th>
                    </tr>
                  </thead>
                  <tbody id="domicilios_seleccionados"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="inner-wrap form-row">
            <div class="form-group col-sm-12">
              <button type="submit" class="btn btn-success w-100">Guardar propietario</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
  <!-- FIN MAESTRO DE PROPIETARIOS -->
  <script>
    function TogglePropietarioUpdate(mode) {
      var formEdit = document.getElementById('FormEditarPropietario');
      var formInm = document.getElementById('FormAgregarInmueble');
      if (!formEdit || !formInm) return;
      if (mode === 'ShowInmueble') {
        formEdit.classList.add('d-none');
        formInm.classList.remove('d-none');
      } else {
        formInm.classList.add('d-none');
        formEdit.classList.remove('d-none');
      }
    }
  </script>

  <script>
    (function() {
      var torreSelect = document.getElementById('select_torre_prop');
      var domicilioSelect = document.getElementById('select_domicilio_prop');
      var listaSeleccionados = document.getElementById('domicilios_seleccionados');
      var listaWrap = document.getElementById('domicilios_seleccionados_wrap');
      if (!torreSelect || !domicilioSelect || !listaSeleccionados || !listaWrap) return;

      function filtrarDomicilios() {
        var torreVal = torreSelect.value;
        Array.from(domicilioSelect.options).forEach(function(opt) {
          if (!opt.value) return;
          var optTorre = opt.getAttribute('data-torre') || '';
          var okTorre = !torreVal || optTorre === torreVal;
          opt.hidden = !okTorre;
        });
        if (domicilioSelect.value && domicilioSelect.selectedOptions.length) {
          var selected = domicilioSelect.selectedOptions[0];
          if (selected.hidden) {
            domicilioSelect.value = '';
          }
        }
      }

      function setSelectPlaceholder(text) {
        if (domicilioSelect.options.length) {
          domicilioSelect.options[0].textContent = text;
        }
      }

      function habilitarSelect() {
        var torreVal = torreSelect.value;
        if (!torreVal) {
          domicilioSelect.disabled = true;
          domicilioSelect.value = '';
          setSelectPlaceholder('Seleccione una torre primero...');
        } else {
          domicilioSelect.disabled = false;
          setSelectPlaceholder('Seleccione un inmueble...');
        }
        filtrarDomicilios();
      }

      function actualizarListaVisible() {
        if (listaSeleccionados.children.length > 0) {
          listaWrap.classList.remove('d-none');
        } else {
          listaWrap.classList.add('d-none');
        }
      }

      function crearItemSeleccionado(id, nombre) {
        var item = document.createElement('tr');
        item.setAttribute('data-id', id);

        var tdNombre = document.createElement('td');
        tdNombre.className = 'centered-cell';
        tdNombre.textContent = nombre;

        var tdAccion = document.createElement('td');
        tdAccion.className = 'centered-cell d-flex justify-content-center';
        var btn = document.createElement('a');
        btn.href = '#';
        btn.className = 'btn btn-primary btn-option-admin border text-light button-table center-all btn-eliminar-prop';
        btn.setAttribute('data-toggle', 'popover');
        btn.setAttribute('data-content', 'Eliminar');
        btn.innerHTML = '<i class="fa fa-trash-o"></i>';
        btn.addEventListener('click', function(event) {
          event.preventDefault();
          item.remove();
          var option = domicilioSelect.querySelector('option[value="' + id + '"]');
          if (option) {
            option.hidden = false;
          }
          if (domicilioSelect.value === id) {
            domicilioSelect.value = '';
          }
          actualizarListaVisible();
        });

        var hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'domicilio';
        hidden.value = id;

        tdAccion.appendChild(btn);
        tdAccion.appendChild(hidden);
        item.appendChild(tdNombre);
        item.appendChild(tdAccion);
        listaSeleccionados.appendChild(item);
        actualizarListaVisible();
      }

      function yaSeleccionado(id) {
        return !!listaSeleccionados.querySelector('[data-id="' + id + '"]');
      }

      domicilioSelect.addEventListener('change', function() {
        var opt = domicilioSelect.selectedOptions[0];
        if (!opt || !opt.value) return;
        var id = opt.value;
        if (yaSeleccionado(id)) {
          domicilioSelect.value = '';
          return;
        }
        crearItemSeleccionado(id, opt.textContent);
        opt.hidden = true;
        domicilioSelect.value = '';
      });

      torreSelect.addEventListener('change', habilitarSelect);
      habilitarSelect();
      actualizarListaVisible();
    })();
  </script>
{% endblock body_block %}